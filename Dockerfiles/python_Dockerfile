# largely based on rocker r-base image

FROM ubuntu:18.04

MAINTAINER "Tobias Verbeke" tobias.verbeke@openanalytics.eu

# Add user to 'staff' group, granting them write privileges to /usr/local/lib/R/site.library
RUN useradd docker \
	&& mkdir /home/docker \
	&& chown docker:docker /home/docker \
	&& addgroup docker staff

RUN apt-get update \ 
	&& apt-get install -y --no-install-recommends \
		ed \
		less \
		locales \
		vim-tiny \
		wget \
		ca-certificates \
		apt-transport-https \
		gsfonts \
		gnupg2 \
		bzip2 \
		gcc \
		git \
		libncurses-dev \
		make \
		time \
		unzip \
		vim \
		zlib1g-dev \
		liblz4-tool \
	&& rm -rf /var/lib/apt/lists/*



RUN apt-get -qq update && apt-get -qq -y install curl bzip2 \
    && curl -sSL https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/miniconda.sh \
    && bash /tmp/miniconda.sh -bfp /usr/local \
    && rm -rf /tmp/miniconda.sh \
    && conda install -y python=3 \
    && conda config --add channels bioconda \
    && conda install pysam==0.15.2 -y \
    && conda install numpy==1.16.1 -y \
    && conda install pandas=0.20.1 -y \
    && conda install pyfaidx==0.5.3 -y \
    && conda install pysamstats==1.1.2 -y \
    && conda install regex -y \
    && conda install scipy==1.2.1 -y \
    && conda update conda \
    && apt-get -qq -y remove curl bzip2 \
    && apt-get -qq -y autoremove \
    && apt-get autoclean \
    && rm -rf /var/lib/apt/lists/* /var/log/dpkg.log \
    && conda clean --all --yes
#    && conda install pysamstats -y \

ENV PATH /opt/conda/bin:$PATH


# download other tools
WORKDIR /usr/local/bin
COPY downloads.sh .
RUN . downloads.sh

# set path:
ENV PATH=/usr/local/bin/samtools/:$PATH

# 7. wrapper
COPY *.py *.R *.md ./
RUN chmod +x *py
RUN chmod +x *.R
